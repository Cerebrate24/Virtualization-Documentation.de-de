# <a name="protecting-guest-virtual-machines-from-cve-2017-5715-branch-target-injection"></a>Schützen von virtuellen Gastcomputern vor CVE 2017 5715 (Branch Target Injection)

Diese Seite enthält zusätzlichen Details zum Schutz von virtuellen Computern auf Hyper-V-Hosts gegen CVE 2017 5715 (Branch Target Injection).  Eine allgemeine Anleitung für Windows Server finden Sie [auf dieser Seite](https://support.microsoft.com/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution).

Die folgenden Schritte sind erforderlich, um sicherzustellen, dass die virtuellen Computer geschützt sind:

1. Aktualisieren Sie das Hostbetriebssystem.
2. Stellen Sie sicher, dass der Virtualisierungshost auf die Firmware aktualisiert wurde, die Updates gegen CVE-2017-5715 enthält.
3. Stellen Sie sicher, dass Hyper-V so konfiguriert ist, dass die neuen Prozessorfunktionen den virtuellen Gastcomputern zur Verfügung stehen.
4. Aktualisieren Sie das Gastbetriebssystem. 
5. Führen Sie einen Kaltstart der virtuellen Gastcomputer aus.

## <a name="update-the-host-operating-system"></a>Hostbetriebssystem aktualisieren

Wenden Sie das Update für das Windows-Betriebssystem auf den Virtualisierungshost an. Informationen zur Aktivierung dieses Updates finden Sie im [Microsoft Knowledge Base-Artikel 4072699](https://support.microsoft.com/help/4072699).

## <a name="ensure-the-virtualization-host-has-been-updated-to-firmware-which-contains-updates-for-cve-2017-5715"></a>Virtualisierungshost auf Firmware aktualisieren, die Updates gegen CVE-2017-5715 enthält

Firmwareupdates von Ihrem OEM enthalten möglicherweise neue Prozessorfunktionen, die vor CVE-2017-5715 schützen ([IBRS, STIBP, IBPB](https://newsroom.intel.com/wp-content/uploads/sites/11/2018/01/Intel-Analysis-of-Speculative-Execution-Side-Channels.pdf)).  Nachdem die Firmware des Virtualisierungshosts aktualisiert wurde, kann der Hypervisor diese zusätzlichen Funktionen für virtuelle Gastcomputer bereitstellen, nachdem die folgenden Schritte ausgeführt wurden.

## <a name="ensure-hyper-v-is-configured-to-expose-new-processor-capabilities-to-guest-virtual-machines"></a>Hyper-V so konfigurieren, dass die neuen Prozessorfunktionen virtuellen Gastcomputern zur Verfügung stehen

Stellen Sie sicher, dass Hyper-V so konfiguriert ist, dass die neuen Prozessorfunktionen virtuellen Gastcomputern zur Verfügung stehen.  Diese Konfiguration basiert auf der [VM-Version](https://docs.microsoft.com/windows-server/virtualization/hyper-v/deploy/upgrade-virtual-machine-version-in-hyper-v-on-windows-or-windows-server) der virtuellen Gastcomputer. 

Wenn alle virtuellen Computer auf dem Host mindestens die VM-Version 8.0 nutzen, ist keine Konfiguration erforderlich.  Diese virtuellen Computer erkennen die neuen Prozessorfunktionen nach einem Kaltstart.

Wenn virtuelle Computer mit einer VM-Version unter 8.0 vorhanden sind, müssen Sie einen bestimmten Registrierungswert auf dem Hostbetriebssystem festlegen.  Dadurch wird Hyper-V so konfiguriert, dass die neuen Prozessorfunktionen virtuellen Gastcomputern mit kleineren VM-Versionsnummern zur Verfügung stehen.

Der Registrierungswert ist `MinVmVersionForCpuBasedMitigations` unter `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization`.  Der Wert sollte im Format „Größe.Kleinste” auf die kleinste VM-Versionsnummer festgelegt werden, die Zugriff auf die aktualisierten Firmwarefunktionen benötigt.  Führen Sie den folgenden Befehl auf dem Host aus, um die Firmware für alle virtuellen Computer auf dem Host verfügbar zu machen (d.h. ab Version 1.0): 

```
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization" /v MinVmVersionForCpuBasedMitigations /t REG_SZ /d "1.0" /f
```
*Hinweis: VM-Version 8.0 wurde mit Windows Server 2016 und Windows 10 Anniversary Update eingeführt.  Hosts, auf denen Windows Server 2012 R2 und oder eine frühere Version ausgeführt wird, müssen den Registrierungswert festlegen.*

*Warnung: Livemigration ist zwischen Hosts mit aktualisierter Firmware und Hosts ohne aktualisierte Firmware nicht möglich.  Weitere Informationen finden Sie unter „Häufig gestellten Fragen” am Ende dieses Dokuments.*

## <a name="optional-configure-pre-skylake-intel-systems-to-use-retpoline"></a>*Optional*: Konfigurieren der _Pre-Skylake_ Intel-Systeme zur Retpoline verwenden

*Warnung: Konfigurieren von VMs auf Pre-Skylake Intel-Hosts für Retpoline Livemigration auf neueren Hosts blockieren soll (d. h. Skylake und höher).*

Standardmäßig werden auf Pre-Skylake Systeme ausgeführte virtuelle Computer gehindert Retpoline verwenden.  Damit um diese Systeme Retpoline basierend Gegenmaßnahmen nutzen zu können, legen `RetsPredictedFromRsbOnly` unter `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization` auf `1`. 

```
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization" /v RetsPredictedFromRsbOnly /t REG_DWORD /d 1 /f
```

Um diese Konfiguration rückgängig machen (d. h. verhindern, dass virtuelle Computer Retpoline nutzen), festlegen `RetsPredictedFromRsbOnly` auf `0`.

## <a name="update-the-guest-operating-system"></a>Gastbetriebssystem aktualisieren

Um den Schutz vor CVE-2017-5715 auf diesen virtuellen Computern zu vervollständigen, muss das Gastbetriebssystem aktualisiert und so konfiguriert werden, dass es diese neuen Funktionen nutzen kann.  Für Microsoft-Betriebssysteme befolgen Sie beim Aktualisieren bitte die Anleitung [in diesem Artikel](https://support.microsoft.com/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution).

*Hinweis: Die Aktualisierung des Gastbetriebssystems kann in diesem Prozess jederzeit erfolgen.  Sie kann vor dem Aktualisieren der Hostfirmware oder nach dem Kaltstart des virtuellen Gastcomputers vorgenommen werden.*

## <a name="perform-a-cold-boot-of-the-guest"></a>Kaltstart des Gastcomputers ausführen

Nach Abschluss der ersten drei Schritte muss für virtuelle Computer ein Kaltstart ausgeführt werden, damit sie die neuen Prozessorfunktionen erkennen.  Dies bedeutet, dass die laufenden VMs vollständig ausgeschaltet werden müssen, bevor sie erneut gestartet werden.  Ein Neustart aus dem Gastbetriebssystem heraus ist nicht ausreichend.

## <a name="frequently-asked-questions"></a>Häufig gestellte Fragen

### <a name="how-does-this-impact-live-migration"></a>Wie wirkt sich dies auf Livemigration aus?

Die Livemigration eines virtuellen Computers mit den neuen Prozessorfunktionen schlägt fehl, wenn auf Hyper-V-Hosts ohne aktualisierte Firmware umgestellt wird.  Um Livemigration auf einen Host ohne aktualisierte Firmware zu ermöglichen, dürfen Sie diesem virtuellen Gastcomputer die aktualisierten Prozessorfunktionen nicht mehr verfügbar machen.  Die einfachste Möglichkeit dafür ist, `MinVmVersionForCpuBasedMitigations` auf eine VM-Versionsnummer festzulegen, die größer ist als die des virtuellen Computers, der migriert werden soll, und einen Kaltstart des virtuellen Computers auszuführen.

Die Migration virtueller Computer ohne die neuen Prozessorfunktionen wird erfolgreich durchgeführt, wenn auf Hyper-V-Hosts mit aktualisierter Firmware umgestellt wird.  Für diese Gastcomputer ist jedoch ein Kaltstart erforderlich, damit sie die aktualisierten Firmwarefunktionen erkennen.

Virtuelle Computer konfiguriert Retpoline auf Intel-Systemen Pre-Skylake schlägt fehl, zu neueren Prozessorfamilien migrieren (d. h. Skylake und höher).

### <a name="what-about-live-migration-of-version-50-virtual-machines-between-windows-server-2012r2-and-windows-server-2016"></a>Was ist bei der Livemigration von virtuellen Computern der Version 5.0 zwischen Windows Server 2012R2 und Windows Server 2016 zu bedenken?
Um den Erfolg für dieses Szenario sicherzustellen, muss der Registrierungswert sowohl auf dem Windows Server 2012R2-System als auch auf dem Windows Server 2016-System festgelegt werden.  Nach der Migration auf Windows Server 2016 hat die VM-Version weiterhin die Nummer 5.0, und daher ist der Registrierungsschlüssel erforderlich, um die neuen Prozessorfunktionen für den virtuellen Computer verfügbar zu machen.  

### <a name="does-this-guidance-apply-to-virtual-machines-running-on-vmware"></a>Gilt diese Anleitung für virtuelle Maschinen, die unter VMWare ausgeführt werden?
Nein, diese Anleitung gilt speziell für virtuelle Computer auf Hyper-V-Hosts.

### <a name="does-this-guidance-apply-to-hyper-v-on-windows-10"></a>Gilt diese Anleitung für Hyper-V unter Windows 10?
Ja, für virtuelle Computer, die auf Windows Server und Client ausgeführt werden, gelten die gleichen Schritte.

### <a name="do-i-need-to-install-the-firmware-updates-before-performing-a-cold-boot-of-the-virtual-machines"></a>Muss ich die Firmwareupdates vor einem Kaltstart der virtuellen Computer installieren?
Ja, Sie müssen Betriebssystem und Firmware des Hosts aktualisieren, bevor Sie Ihre virtuellen Computer neu starten.

### <a name="what-can-i-do-if-my-oem-does-not-yet-provide-an-updated-firmware"></a>Was kann ich tun, wenn mein OEM noch keine aktualisierte Firmware anbietet?
Lesen Sie den Artikel [Alternativer Schutz für Windows Server 2016 Hyper-V-Hosts gegen spekulative Seitenkanalangriffe (Speculative Execution Side-Channel-Angriffe)](https://docs.microsoft.com/virtualization/hyper-v-on-windows/CVE-2017-5715-and-hyper-v-hosts).

### <a name="how-do-i-check-the-vm-version-for-my-virtual-machines"></a>Wie kann ich die VM-Version meiner virtuellen Computer feststellen?
Führen Sie auf dem Hyper-V-Host den folgenden PowerShell-Befehl aus.
``` PowerShell
Get-VM * | Format-Table Name, Version  
```

### <a name="do-i-need-to-do-something-different-to-protect-virtual-machines-running-under-processor-compatibility-mode"></a>Muss ich andere Maßnahmen ergreifen, um virtuelle Computer zu schützen, die im „Prozessorkompatibilitätsmodus” ausgeführt werden?
Nein.  Nachdem Sie alle Anweisungen auf dieser Seite befolgt haben, sind die neuen Prozessorfunktionen auch für virtuelle Computer verfügbar, die im Prozessorkompatibilitätsmodus gestartet wurden.

### <a name="what-if-only-half-of-the-machines-in-my-cluster-have-received-a-firmware-update"></a>Was ist, wenn nur die Hälfte der Computer im Cluster ein Firmwareupdate erhalten haben?
Dies wirkt sich auf die Livemigration innerhalb des Clusters aus.  Für virtuelle Computer mit den neuen Prozessorfunktionen ist eine Livemigration auf Hosts ohne aktualisiert Firmware nicht möglich.  

### <a name="how-can-i-validate-that-the-guest-virtual-machine-has-access-to-the-new-processor-features"></a>Wie kann ich überprüfen, ob der virtuelle Computer Zugriff auf die neuen Prozessorfeatures hat?
Verwenden Sie das PowerShell-Modul/Skript „Speculation Control”.  Detaillierte Informationen dazu finden Sie [auf dieser Seite](https://support.microsoft.com/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution).

